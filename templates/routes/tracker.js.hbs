{{#if analytics}}
/*
 * @author wingbot.ai
 */
'use strict';

const analytics = require('universal-analytics');
const { replaceDiacritics } = require('webalize');
const wrapRoute = require('../lib/wrapRoute');
const config = require('../config');

function trackEvent (sender, text, url) {
    const tracker = analytics(config.gaCode, sender, { strictCidFormat: false });

    const word = replaceDiacritics(text).replace(/\s+/g, ' ').toLowerCase().trim();

    tracker.event('User: Button - url', url, word);

    return new Promise((r) => tracker.send(r));
}

module.exports.handler = wrapRoute(async (event) => {
    const { url = null, text = null, sender = null } = event.queryStringParameters || {};

    if (!url || !text || !sender) {
        return {
            statusCode: 404
        };
    }

    await trackEvent(sender, text, url);

    return {
        statusCode: 301,
        headers: {
            Location: url
        }
    };
});
{{/if}}