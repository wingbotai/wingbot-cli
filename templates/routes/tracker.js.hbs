/**
 * @author wingbot.ai
 */
'use strict';

{{#unless universalAnalytics}}
{{#unless tableStorage}}
const wrapRoute = require('../lib/wrapRoute');

// eslint-disable-next-line no-unused-vars
async function trackEvent (sender, text, url) {
    // put the tracking here
}
{{/unless}}
{{/unless}}
{{#if universalAnalytics}}
const analytics = require('universal-analytics');
const { replaceDiacritics } = require('webalize');
const wrapRoute = require('../lib/wrapRoute');
const config = require('../config');

function trackEvent (sender, text, url) {
    const tracker = analytics(config.gaCode, sender, { strictCidFormat: false });

    const word = replaceDiacritics(text).replace(/\s+/g, ' ').toLowerCase().trim();

    tracker.event('User: Button - url', url, word);

    return new Promise((r) => tracker.send(r));
}
{{/if}}
{{#if tableStorage}}
const { replaceDiacritics } = require('webalize');
const wrapRoute = require('../lib/wrapRoute');
const { analyticsStorage } = require('../lib/tableStorage');
const config = require('../config');

async function trackEvent (sender, text, url) {

    const pageId = config.orchestrator
        ? config.orchestrator.pageId
        : 'msteams';

    const {
        sessionId,
        conversationId
    } = await analyticsStorage
        .getOrCreateUserSession(pageId, sender);

    const word = replaceDiacritics(text).replace(/\s+/g, ' ').toLowerCase().trim();

    await analyticsStorage.storeEvent({
        type: 'conversation',
        pageId,
        senderId: sender,
        conversationId,
        sessionId,
        category: 'User: Button - url',
        action: url,
        label: word,
        value: 1
    });
}
{{/if}}

module.exports.handler = wrapRoute(async (event) => {
    const { url = null, text = null, sender = null } = event.queryStringParameters || {};

    if (!url || !text || !sender) {
        return {
            statusCode: 404
        };
    }

    await trackEvent(sender, text, url);

    return {
        statusCode: 301,
        headers: {
            Location: url
        }
    };
});
